[phases.setup]
nixPkgs = [
    "nodejs_22",
    "pnpm-9_x",
    "bash-completion",
    "vim",
    "less",
    "git",
    "htop",
    "tree",
    "jq",
    "ncdu",
    "ripgrep",
    "fzf",
    "fd"
]

[phases.install]
cmds = [
    "npm install -g corepack@0.24.1 && corepack enable",
    "pnpm i --frozen-lockfile"
]

[phases.build]
cmds = ["pnpm run build"]

[start]
cmd = '''
#!/bin/bash
# Create .env.local if needed
if [ ! -f .env.local ] && [ ! -z "$ANTHROPIC_API_KEY" ]; then
    echo "ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY" > .env.local
    echo "Created .env.local file with API key"
fi

# Set up bash configuration
cat > ~/.bashrc << 'EOBASHRC'
# Terminal settings
source /etc/bash_completion
export TERM=xterm-256color

# Aliases
alias ls='ls --color=auto'
alias ll='ls -l'
alias la='ls -la'
alias ..='cd ..'
alias ...='cd ../..'
alias grep='grep --color=auto'

# History settings
export HISTSIZE=10000
export HISTFILESIZE=20000
export HISTCONTROL=ignoreboth:erasedups
shopt -s histappend

# Colored prompt
PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
EOBASHRC

# Set up inputrc
cat > ~/.inputrc << 'EOINPUTRC'
"\e[A": history-search-backward
"\e[B": history-search-forward
set completion-ignore-case on
set show-all-if-ambiguous on
set colored-stats on
EOINPUTRC

# Start the application
source ~/.bashrc
exec pnpm run start
'''

[variables]
ANTHROPIC_API_KEY = "${ANTHROPIC_API_KEY}"
